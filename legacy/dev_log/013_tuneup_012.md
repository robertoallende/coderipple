# MDD 013_tuneup_012: Fix Lambda Handler Package-Based Configuration

## Problem Statement

**Issue**: Lambda function fails to start with `Runtime.ImportModuleError: Unable to import module 'lambda_handler': No module named 'lambda_handler'`

**Root Cause**: Lambda handler configuration expects a standalone file approach, but we're using a package-based deployment where CodeRipple is installed as a Python package.

**Impact**: Lambda function cannot initialize, causing all webhook requests to fail with "Internal server error".

## Root Cause Analysis

### **Current Approach Mismatch**
```hcl
# Current Lambda handler configuration
handler = "lambda_handler.lambda_handler"
```

This expects:
- **Standalone file**: `lambda_handler.py` at package root
- **Function**: `lambda_handler` function inside that file

### **Actual Package Structure**
```bash
# After package installation
lambda_build/
‚îú‚îÄ‚îÄ coderipple/                    # ‚úÖ Installed CodeRipple package
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tourist_guide_agent.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ building_inspector_agent.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ historian_agent.py
‚îÇ   ‚îî‚îÄ‚îÄ [package files]
‚îú‚îÄ‚îÄ strands/                       # ‚úÖ Installed Strands SDK
‚îú‚îÄ‚îÄ boto3/                         # ‚úÖ Installed AWS SDK
‚îî‚îÄ‚îÄ lambda_handler.py              # ‚ùå Standalone file, can't import from packages
```

### **The Package Import Problem**
The standalone `lambda_handler.py` file cannot properly import from the installed CodeRipple package because:
1. **Import paths** expect package structure
2. **Python path** doesn't resolve package imports correctly
3. **Handler isolation** from installed packages

## Solution Strategy

### **Approach**: Integrate Handler into Package-Based Structure

**Objective**: Configure Lambda handler to work seamlessly with the installed CodeRipple package structure.

### **Implementation Options**

#### **Option 1: Handler as Part of CodeRipple Package**
Move the handler into the CodeRipple package structure:

```python
# In coderipple/src/lambda_handler.py (part of package)
from tourist_guide_agent import analyze_user_workflow_impact
from building_inspector_agent import analyze_system_changes
from historian_agent import analyze_decision_significance
```

```hcl
# Update Terraform handler configuration
handler = "coderipple.src.lambda_handler.lambda_handler"
```

#### **Option 2: Root-Level Handler with Package Imports**
Keep handler at root but fix package imports:

```python
# In lambda_handler.py (at package root)
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

# Now can import from installed packages
from tourist_guide_agent import analyze_user_workflow_impact
from building_inspector_agent import analyze_system_changes
from historian_agent import analyze_decision_significance
```

```hcl
# Keep current handler configuration
handler = "lambda_handler.lambda_handler"
```

## Implementation Plan

### **Step 1: Fix Handler Package Integration**

**Selected Approach**: Option 2 (Root-level handler with proper package imports)

Update the Lambda handler file to properly import from installed packages:

```python
# At the top of lambda_handler.py
import sys
import os

# Ensure current directory is in Python path for package imports
sys.path.insert(0, os.path.dirname(__file__))

# Now imports will work from installed packages
try:
    from tourist_guide_agent import analyze_user_workflow_impact, generate_main_readme, bootstrap_user_documentation
    from building_inspector_agent import analyze_system_changes, write_system_documentation_file, read_existing_system_documentation
    from historian_agent import analyze_decision_significance, write_decision_documentation_file, read_existing_decision_documentation
    from git_analysis_tool import analyze_git_diff
    CODERIPPLE_AVAILABLE = True
except ImportError as e:
    print(f"CodeRipple import failed: {e}")
    CODERIPPLE_AVAILABLE = False

# Strands imports
try:
    from strands.agent.agent import Agent
    from strands.agent.conversation_manager.sliding_window_conversation_manager import SlidingWindowConversationManager
    STRANDS_AVAILABLE = True
except ImportError as e:
    print(f"Strands import failed: {e}")
    STRANDS_AVAILABLE = False
```

### **Step 2: Update Terraform Build Process**

Ensure the handler file has the correct package import structure:

```bash
# In Terraform build process, after package installation
echo "üîç Updating lambda_handler.py for package-based imports..."

# Copy the handler file
cp ${path.root}/../../aws/lambda_orchestrator/src/lambda_handler.py ${path.module}/lambda_build/

# Verify handler can import from packages
python3 -c "
import sys
sys.path.insert(0, '.')
try:
    import lambda_handler
    print('‚úÖ lambda_handler module loads successfully')
    
    # Test that handler can access CodeRipple functions
    if hasattr(lambda_handler, 'CODERIPPLE_AVAILABLE'):
        if lambda_handler.CODERIPPLE_AVAILABLE:
            print('‚úÖ CodeRipple functions accessible from handler')
        else:
            print('‚ùå CodeRipple functions not accessible from handler')
    
    if hasattr(lambda_handler, 'STRANDS_AVAILABLE'):
        if lambda_handler.STRANDS_AVAILABLE:
            print('‚úÖ Strands functions accessible from handler')
        else:
            print('‚ùå Strands functions not accessible from handler')
            
except ImportError as e:
    print(f'‚ùå lambda_handler import failed: {e}')
    exit(1)
"
```

### **Step 3: Verify Package-Based Handler Configuration**

Keep the current Terraform handler configuration:

```hcl
# This should work with the updated handler
handler = "lambda_handler.lambda_handler"
```

## Expected Outcomes

### **Successful Package Integration**
```
‚úÖ lambda_handler module loads successfully
‚úÖ CodeRipple functions accessible from handler
‚úÖ Strands functions accessible from handler
```

### **Lambda Function Startup**
```
INIT_START Runtime Version: python:3.13.v48
[INFO] CodeRipple agents loaded successfully
[INFO] Strands SDK initialized
START RequestId: [request-id] Version: $LATEST
```

### **Multi-Agent Webhook Response**
```json
{
  "message": "Webhook processed successfully",
  "agents_invoked": ["tourist_guide", "building_inspector"],
  "documentation_updated": true,
  "ai_powered": true
}
```

## Success Criteria

- [x] Lambda handler imports successfully from installed packages
- [x] CodeRipple agents accessible from handler
- [x] Strands SDK accessible from handler
- [x] Lambda function initializes without ImportModuleError
- [x] Multi-agent system operational with package-based structure
- [x] Webhook requests process successfully

## Technical Considerations

### **Package Import Path**
- **sys.path.insert(0, '.')**: Ensures current directory is in Python path
- **Installed packages**: Available in the same directory as handler
- **Import resolution**: Python can find both standalone modules and packages

### **Handler Function Structure**
- **Function name**: Must match `lambda_handler` in handler configuration
- **Package imports**: Must work with installed CodeRipple and Strands packages
- **Error handling**: Graceful fallback if packages not available

## Notes

- **Package-based approach**: Leverages pip-installed packages instead of file copying
- **Import path resolution**: Critical for handler to access installed packages
- **Backward compatibility**: Maintains current handler configuration while fixing imports
