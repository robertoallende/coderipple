# MDD 013_tuneup_006: Requirements.txt Path Resolution Issue in GitHub Actions

## Problem Statement

**Issue**: GitHub Actions deployment failing with "file:///home/runner/work/coderipple/coderipple does not appear to be a Python project: neither 'setup.py' nor 'pyproject.toml' found."

**Error**: 
```
Obtaining file:///home/runner/work/coderipple/coderipple (from -r aws/lambda_orchestrator/requirements.txt (line 6))
ERROR: file:///home/runner/work/coderipple/coderipple (from -r aws/lambda_orchestrator/requirements.txt (line 6)) does not appear to be a Python project: neither 'setup.py' nor 'pyproject.toml' found.
```

**Root Cause**: The requirements.txt path `-e ../../coderipple/coderipple` is resolving incorrectly in the GitHub Actions environment, pointing to the wrong directory structure.

**Impact**: Lambda deployment fails during package installation phase, preventing multi-agent system deployment.

**Context**: 
- MDD 013_tuneup_005 implemented Python package approach ✅
- CodeRipple package builds successfully in first installation ✅
- Second installation attempt fails due to path resolution ❌

## Root Cause Analysis

### **GitHub Actions Directory Structure**
```
/home/runner/work/coderipple/coderipple/    # GitHub Actions workspace
├── coderipple/                             # CodeRipple Python package directory
│   ├── setup.py                           # ✅ Python package configuration
│   ├── src/                               # ✅ Package source code
│   └── pyproject.toml                     # ✅ Modern Python packaging
├── aws/
│   └── lambda_orchestrator/
│       └── requirements.txt               # ❌ Problematic path reference
├── infra/
│   └── terraform/
│       └── main.tf                        # Package assembly location
└── [other project files]
```

### **Path Resolution Analysis**

**Current Requirements.txt Path**:
```
-e ../../coderipple/coderipple
```

**From Lambda Build Context** (`infra/terraform/lambda_build/`):
- **Expected**: `../../coderipple/coderipple` → `/home/runner/work/coderipple/coderipple/coderipple/`
- **Actual**: Path resolves to repository root instead of package directory

### **Terraform Package Assembly Context**
The pip install command runs from:
```bash
cd ${path.module}/lambda_build  # /home/runner/work/coderipple/coderipple/infra/terraform/lambda_build/
python3 -m pip install -r requirements.txt -t .
```

**Path Resolution from Build Directory**:
- **Build Location**: `/home/runner/work/coderipple/coderipple/infra/terraform/lambda_build/`
- **Requirements Path**: `../../coderipple/coderipple`
- **Resolves To**: `/home/runner/work/coderipple/coderipple/coderipple/` ❌ (incorrect)
- **Should Resolve To**: `/home/runner/work/coderipple/coderipple/coderipple/` ✅

## Solution Strategy

### **Approach**: Fix Relative Path Resolution in Terraform Context

**Objective**: Ensure the CodeRipple package path in requirements.txt resolves correctly from the Terraform build directory in GitHub Actions.

### **Selected Solution: Use Terraform Path Variables**

**Why This Solution**: Instead of relying on relative paths in requirements.txt that can resolve differently in various contexts, use Terraform's path resolution to install the CodeRipple package directly with absolute paths during the build process.

### **Implementation**

**Remove CodeRipple from requirements.txt**:
```
# AWS Strands SDK for multi-agent orchestration
strands-agents==0.1.6
strands-agents-tools==0.1.4

# AWS SDK for Lambda runtime and services
boto3==1.38.32
botocore==1.38.32

# HTTP requests for GitHub API integration  
requests==2.32.3

# Note: CodeRipple package installed separately via Terraform
```

**Install CodeRipple via Terraform with Absolute Path**:
```bash
# In null_resource.prepare_lambda_package
# Install requirements first (without CodeRipple)
cd ${path.module}/lambda_build
python3 -m pip install -r requirements.txt -t .

# Install CodeRipple package with absolute path
python3 -m pip install -e ${path.root}/../../coderipple -t .
```

## Implementation Plan

### **Phase 1: Remove CodeRipple from Requirements.txt**

**Step 1: Update Requirements.txt**
Remove the problematic relative path reference:

```
# AWS Strands SDK for multi-agent orchestration
strands-agents==0.1.6
strands-agents-tools==0.1.4

# AWS SDK for Lambda runtime and services
boto3==1.38.32
botocore==1.38.32

# HTTP requests for GitHub API integration  
requests==2.32.3

# Additional dependencies
python-dotenv>=1.1.0
pydantic>=2.11.5
python-dateutil>=2.9.0
httpx>=0.28.1
tenacity>=9.1.2
markdown-it-py>=3.0.0
```

### **Phase 2: Update Terraform Package Assembly**

**Step 2: Modify Terraform Build Process**
Update `null_resource.prepare_lambda_package` to handle CodeRipple installation separately:

```bash
# Install standard requirements first
cd ${path.module}/lambda_build
python3 -m pip install -r requirements.txt -t .

# Install CodeRipple package with Terraform-resolved absolute path
python3 -m pip install -e ${path.root}/../../coderipple -t .
```

**Step 3: Add Error Handling**
```bash
# Verify CodeRipple package exists before installation
if [ ! -f "${path.root}/../../coderipple/setup.py" ]; then
  echo "ERROR: CodeRipple package not found at ${path.root}/../../coderipple"
  exit 1
fi

# Install with verbose output for debugging
python3 -m pip install -e ${path.root}/../../coderipple -t . -v
```

### **Phase 3: Validate Installation**

**Step 4: Add Installation Verification**
```bash
# Verify CodeRipple modules are available
python3 -c "
import sys
sys.path.insert(0, '.')
try:
    import tourist_guide_agent
    import building_inspector_agent
    import historian_agent
    print('✅ CodeRipple modules installed successfully')
except ImportError as e:
    print(f'❌ CodeRipple import failed: {e}')
    exit(1)
"
```

## Expected Outcomes

### **Immediate Resolution**
- **Path Resolution**: No more relative path issues in requirements.txt
- **Package Installation**: CodeRipple installs with absolute Terraform paths
- **Build Success**: GitHub Actions deployment completes successfully
- **Lambda Deployment**: Function deploys with all dependencies

### **System Response Changes**
**Before Fix:**
```
ERROR: file:///home/runner/work/coderipple/coderipple does not appear to be a Python project
```

**After Fix:**
```
✅ Installing requirements from requirements.txt
✅ Installing CodeRipple package from /home/runner/work/coderipple/coderipple/coderipple
✅ Lambda deployment package created successfully
```

**Webhook Response:**
```json
{
  "message": "Webhook processed successfully",
  "agents_invoked": ["tourist_guide", "building_inspector"],
  "documentation_updated": true
}
```

## Technical Considerations

### **Terraform Path Resolution**
- **${path.root}**: Resolves to Terraform configuration root directory
- **${path.module}**: Resolves to current module directory
- **Absolute Paths**: Eliminate context-dependent path resolution issues

### **Package Installation Order**
1. **Standard Dependencies**: Install from requirements.txt first
2. **CodeRipple Package**: Install separately with absolute path
3. **Verification**: Confirm all modules are importable

### **GitHub Actions Environment**
- **Workspace**: `/home/runner/work/coderipple/coderipple/`
- **Build Context**: Terraform runs from `infra/terraform/`
- **Path Resolution**: Terraform variables resolve correctly in CI environment

## Risk Assessment

### **Low Risk**
- Removing relative path from requirements.txt (eliminates problematic dependency)
- Using Terraform path variables (standard Terraform practice)
- Separate installation steps (more control and debugging capability)

### **Medium Risk**
- Build process changes (requires testing in GitHub Actions)

### **Mitigation Strategies**
- **Explicit Error Handling**: Check for package existence before installation
- **Verbose Installation**: Use pip verbose mode for debugging
- **Installation Verification**: Test imports after installation
- **Rollback Plan**: Can revert to requirements.txt approach if needed

## Success Criteria

- [x] GitHub Actions deployment completes without path resolution errors
- [x] CodeRipple package installs successfully in Lambda build
- [x] All dependencies (Strands SDK + CodeRipple) available in Lambda package
- [x] Lambda function deploys successfully
- [x] Webhook processing returns success responses
- [x] Multi-agent system operational with proper imports
- [x] CloudWatch logs show successful function initialization

## Related Components

- **Requirements**: `aws/lambda_orchestrator/requirements.txt`
- **Terraform**: `infra/terraform/main.tf` (null_resource.prepare_lambda_package)
- **CodeRipple Package**: `coderipple/setup.py` and `coderipple/src/`
- **GitHub Actions**: CI/CD pipeline and workspace structure

## Documentation Impact

This tuneup demonstrates:
- **Path Resolution Issues**: Understanding relative vs absolute paths in CI environments
- **Terraform Path Variables**: Using Terraform for reliable path resolution
- **Package Installation Strategies**: Separating problematic dependencies from standard requirements
- **CI/CD Debugging**: Identifying and resolving deployment path issues

## Notes

- **Relative paths in requirements.txt** can be problematic in different execution contexts
- **Terraform path variables** provide reliable absolute path resolution
- **Separate installation steps** offer better control and error handling
- **GitHub Actions workspace structure** affects path resolution differently than local development
