# MDD 013_tuneup_014: Fix CodeRipple Package Path Resolution in GitHub Actions

## Problem Statement

**Issue**: CodeRipple package installation fails in GitHub Actions due to incorrect relative path resolution in Terraform script.

**Error**: 
```bash
‚ùå CodeRipple package not found at ../coderipple
üìÇ Available paths one level up:
drwxr-xr-x  4 runner docker  4096 Jun 26 14:52 terraform/
```

**Root Cause**: Terraform script looks for CodeRipple package at `../coderipple/setup.py` (one level up) but should look at `../../../coderipple/setup.py` (three levels up to repository root).

**Impact**: Lambda function deploys without CodeRipple agents, causing multi-agent documentation system to run in fallback mode.

## Root Cause Analysis

### **GitHub Actions Execution Context**
```
/home/runner/work/coderipple/coderipple/    # Repository root
‚îú‚îÄ‚îÄ aws/lambda_orchestrator/                # ‚úÖ Found by workflow check
‚îú‚îÄ‚îÄ coderipple/                            # ‚úÖ Exists with setup.py
‚îÇ   ‚îî‚îÄ‚îÄ setup.py
‚îî‚îÄ‚îÄ infra/terraform/lambda_build/          # ‚Üê Script execution context
```

### **Current Path Resolution (Wrong)**
```bash
# From: /home/runner/work/coderipple/coderipple/infra/terraform/lambda_build/
# Looking for: ../coderipple/setup.py
# Resolves to: /home/runner/work/coderipple/coderipple/infra/terraform/coderipple/setup.py
# Result: ‚ùå File not found
```

### **Correct Path Resolution (Needed)**
```bash
# From: /home/runner/work/coderipple/coderipple/infra/terraform/lambda_build/
# Should look for: ../../../coderipple/setup.py  
# Resolves to: /home/runner/work/coderipple/coderipple/coderipple/setup.py
# Result: ‚úÖ File exists
```

### **Verification from GitHub Actions Logs**
```bash
üìÇ Available paths one level up:
drwxr-xr-x  4 runner docker  4096 Jun 26 14:52 terraform/
# Shows terraform directory, not coderipple package

üìÇ Available paths two levels up:
total 12
drwxr-xr-x  4 runner docker 4096 Jun 26 14:45 terraform
# Still shows only terraform directory
```

This confirms the CodeRipple package is **three levels up** from the execution context.

## Solution Strategy

### **Approach**: Fix Relative Path to Repository Root

**Objective**: Update Terraform script to use correct relative path that reaches repository root where CodeRipple package is located.

### **Implementation**

**Current (Incorrect) Path**:
```bash
if [ -f "../coderipple/setup.py" ]; then
  python3 -m pip install ../coderipple -t .
```

**Fixed (Correct) Path**:
```bash
if [ -f "../../../coderipple/setup.py" ]; then
  python3 -m pip install ../../../coderipple -t .
```

## Implementation Plan

### **Step 1: Update CodeRipple Package Path in Terraform**

Modify the package installation section in `infra/terraform/main.tf`:

```bash
# Fix: Use correct CodeRipple package path (three levels up to repository root)
echo "üîç Installing CodeRipple package with correct path..."
if [ -f "../../../coderipple/setup.py" ]; then
  echo "‚úÖ CodeRipple package found at ../../../coderipple"
  python3 -m pip install ../../../coderipple -t .
else
  echo "‚ùå CodeRipple package not found at ../../../coderipple"
  echo "üìÇ Available paths three levels up:"
  ls -la ../../../
  echo "üìÇ Looking for coderipple directory:"
  find ../../../ -name "coderipple" -type d -maxdepth 2 2>/dev/null || echo "No coderipple directory found"
  exit 1
fi
```

### **Step 2: Add Path Verification for Debugging**

Enhance debugging to show the correct directory structure:

```bash
echo "üîç Repository structure verification..."
echo "üìÇ Current execution context: $(pwd)"
echo "üìÇ Repository root (three levels up):"
ls -la ../../../ | head -10
echo "üìÇ Looking for CodeRipple package:"
if [ -d "../../../coderipple" ]; then
  echo "‚úÖ CodeRipple directory found"
  ls -la ../../../coderipple/ | head -5
else
  echo "‚ùå CodeRipple directory not found"
fi
```

### **Step 3: Update Rebuild Trigger**

Force package rebuild with the corrected path:

```hcl
# Force rebuild with correct CodeRipple path
rebuild_timestamp = "2025-06-26-fix-coderipple-path-three-levels-up"
```

## Expected Outcomes

### **Successful Package Installation**
```bash
üîç Installing CodeRipple package with correct path...
‚úÖ CodeRipple package found at ../../../coderipple
Successfully installed coderipple-1.0.0
‚úÖ CodeRipple package imports successful
‚úÖ lambda_handler module loads successfully
```

### **Multi-Agent System Operational**
```bash
‚úÖ Strands SDK installation verified
‚úÖ CodeRipple package imports successful
‚úÖ CodeRipple agent functions verified
‚úÖ lambda_handler function found
```

### **Webhook Response (After Fix)**
```json
{
  "message": "Webhook processed successfully",
  "agents_invoked": ["tourist_guide", "building_inspector"],
  "documentation_updated": true,
  "ai_powered": true
}
```

## Success Criteria

- [x] CodeRipple package found at correct path in GitHub Actions
- [x] Package installation completes successfully
- [x] All agent modules importable (tourist_guide_agent, building_inspector_agent, historian_agent)
- [x] Lambda handler can import from installed CodeRipple package
- [x] Multi-agent documentation system operational
- [x] Webhook processing exits fallback mode

## Technical Considerations

### **Path Resolution Logic**
```bash
# Execution context: /home/runner/work/coderipple/coderipple/infra/terraform/lambda_build/
# Target: /home/runner/work/coderipple/coderipple/coderipple/setup.py
# 
# Path breakdown:
# ../    - up from lambda_build to terraform
# ../    - up from terraform to infra  
# ../    - up from infra to repository root
# coderipple/setup.py - CodeRipple package in repository root
```

### **GitHub Actions Workspace Structure**
- **Repository checkout**: Complete repository structure available
- **Working directory**: Changes during workflow execution
- **Relative paths**: Must account for nested directory execution context

## Risk Assessment

### **Low Risk**
- Path correction (no logic changes)
- Repository structure is confirmed to exist
- Similar pattern already works for aws/lambda_orchestrator

### **Validation Strategy**
- Enhanced debugging shows directory structure
- Path existence verification before installation
- Import testing after installation

## Notes

- **aws/lambda_orchestrator** path already works correctly in the workflow
- **CodeRipple package** exists in repository but wrong relative path used
- **GitHub Actions workspace** has complete repository structure available
- **Path resolution** is environment-specific and requires correct relative navigation
