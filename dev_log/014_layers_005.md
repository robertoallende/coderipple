# MDD 014_layers_005: Enhanced CI/CD Testing Framework

## Objective

Implement comprehensive CI/CD testing framework with detailed debugging capabilities to validate Python environments, dependencies, imports, and layer functionality before deployment.

## Current CI/CD Testing Gaps

### Identified Issues from Units 13.1-13.15
- **No Python version consistency validation**
- **No dependency resolution testing**
- **No import path validation**
- **No layer structure verification**
- **Limited debugging information on failures**
- **No pre-deployment package integrity checks**

### Impact of Missing Validation
- Deployment failures discovered only in production
- Complex debugging of package path issues
- Time-consuming troubleshooting cycles
- Risk of broken deployments reaching production

## Enhanced Testing Framework Architecture

### Testing Pipeline Stages

```
Pre-Deployment Validation Pipeline:
┌─────────────────────────────────────────────────────────────────┐
│ Stage 1: Environment Validation                                 │
│ ├── Python version consistency                                  │
│ ├── Virtual environment integrity                               │
│ └── Package manager compatibility                               │
├─────────────────────────────────────────────────────────────────┤
│ Stage 2: Dependency Resolution Testing                          │
│ ├── Requirements.txt validation                                 │
│ ├── Dependency conflict detection                               │
│ ├── Version compatibility matrix                                │
│ └── Security vulnerability scanning                             │
├─────────────────────────────────────────────────────────────────┤
│ Stage 3: Import Path Validation                                 │
│ ├── Package import testing                                      │
│ ├── Module resolution verification                              │
│ ├── Circular dependency detection                               │
│ └── CodeRipple package structure validation                     │
├─────────────────────────────────────────────────────────────────┤
│ Stage 4: Layer Structure Verification                           │
│ ├── Layer directory structure validation                        │
│ ├── Python path compatibility testing                           │
│ ├── Layer size and limit compliance                             │
│ └── Runtime compatibility verification                          │
├─────────────────────────────────────────────────────────────────┤
│ Stage 5: Integration Testing                                    │
│ ├── Layer functionality testing                                 │
│ ├── Lambda environment simulation                               │
│ ├── Multi-agent coordination testing                            │
│ └── Performance impact assessment                               │
└─────────────────────────────────────────────────────────────────┘
```

## GitHub Actions Workflow Enhancement

### Enhanced Validation Job
```yaml
name: Enhanced Pre-Deployment Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  comprehensive-validation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13']
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Stage 1 - Environment Validation
      run: |
        echo "🔍 Stage 1: Environment Validation"
        ./scripts/validate-environment.sh
        
    - name: Stage 2 - Dependency Resolution Testing
      run: |
        echo "🔍 Stage 2: Dependency Resolution Testing"
        ./scripts/validate-dependencies.sh
        
    - name: Stage 3 - Import Path Validation
      run: |
        echo "🔍 Stage 3: Import Path Validation"
        ./scripts/validate-imports.sh
        
    - name: Stage 4 - Layer Structure Verification
      run: |
        echo "🔍 Stage 4: Layer Structure Verification"
        ./scripts/validate-layers.sh
        
    - name: Stage 5 - Integration Testing
      run: |
        echo "🔍 Stage 5: Integration Testing"
        ./scripts/validate-integration.sh
```

## Validation Scripts Implementation

### Stage 1: Environment Validation Script
```bash
#!/bin/bash
# scripts/validate-environment.sh

set -e
source scripts/common-functions.sh

log_section "Environment Validation"

# Python Version Consistency Check
validate_python_version() {
    log_step "Validating Python version consistency"
    
    EXPECTED_VERSION="3.13"
    CURRENT_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
    
    if [ "$CURRENT_VERSION" != "$EXPECTED_VERSION" ]; then
        log_error "Python version mismatch: expected $EXPECTED_VERSION, got $CURRENT_VERSION"
        exit 1
    fi
    
    log_success "Python version $CURRENT_VERSION validated"
    
    # Detailed version information for debugging
    log_debug "Python executable: $(which python3)"
    log_debug "Python version: $(python3 --version)"
    log_debug "Pip version: $(pip --version)"
}

# Virtual Environment Integrity Check
validate_virtual_environment() {
    log_step "Validating virtual environment capability"
    
    # Test virtual environment creation
    python3 -m venv test_venv
    source test_venv/bin/activate
    
    # Verify isolation
    pip install requests==2.31.0
    python3 -c "import requests; print(f'Requests version: {requests.__version__}')"
    
    deactivate
    rm -rf test_venv
    
    log_success "Virtual environment functionality validated"
}

# Package Manager Compatibility Check
validate_package_manager() {
    log_step "Validating package manager compatibility"
    
    # Check pip functionality
    pip --version > /dev/null
    pip list > /dev/null
    
    # Check platform-specific installation capability
    pip install --dry-run --platform=manylinux2014_x86_64 requests
    
    log_success "Package manager compatibility validated"
}

# Execute validation steps
validate_python_version
validate_virtual_environment
validate_package_manager

log_section_complete "Environment Validation"
```

### Stage 2: Dependency Resolution Testing Script
```bash
#!/bin/bash
# scripts/validate-dependencies.sh

set -e
source scripts/common-functions.sh

log_section "Dependency Resolution Testing"

# Requirements.txt Validation
validate_requirements_files() {
    log_step "Validating requirements.txt files"
    
    # Check main requirements file
    if [ ! -f "coderipple/requirements.txt" ]; then
        log_error "Main requirements.txt not found"
        exit 1
    fi
    
    # Validate syntax
    python3 -m pip check --dry-run -r coderipple/requirements.txt
    
    # Check for version pinning
    UNPINNED=$(grep -v "==" coderipple/requirements.txt | grep -v "^#" | grep -v "^$" || true)
    if [ -n "$UNPINNED" ]; then
        log_warning "Unpinned dependencies found:"
        echo "$UNPINNED"
    fi
    
    log_success "Requirements.txt validation completed"
}

# Dependency Conflict Detection
detect_dependency_conflicts() {
    log_step "Detecting dependency conflicts"
    
    # Create test environment
    python3 -m venv conflict_test_venv
    source conflict_test_venv/bin/activate
    
    # Install dependencies and check for conflicts
    pip install -r coderipple/requirements.txt
    pip check
    
    # Generate dependency tree for debugging
    pip install pipdeptree
    pipdeptree > dependency_tree.txt
    log_debug "Dependency tree saved to dependency_tree.txt"
    
    deactivate
    rm -rf conflict_test_venv
    
    log_success "No dependency conflicts detected"
}

# Version Compatibility Matrix Testing
test_version_compatibility() {
    log_step "Testing version compatibility matrix"
    
    # Test critical package combinations
    CRITICAL_PACKAGES=(
        "boto3==1.38.32"
        "strands-agents==0.1.6"
        "requests==2.32.3"
    )
    
    python3 -m venv compat_test_venv
    source compat_test_venv/bin/activate
    
    for package in "${CRITICAL_PACKAGES[@]}"; do
        log_debug "Testing compatibility: $package"
        pip install "$package"
        python3 -c "import ${package%%==*}; print(f'${package%%==*} version: {${package%%==*}.__version__}')"
    done
    
    deactivate
    rm -rf compat_test_venv
    
    log_success "Version compatibility validated"
}

# Security Vulnerability Scanning
scan_security_vulnerabilities() {
    log_step "Scanning for security vulnerabilities"
    
    # Install safety for vulnerability scanning
    pip install safety
    
    # Check for known vulnerabilities
    safety check -r coderipple/requirements.txt --json > security_report.json
    
    # Parse results
    VULNERABILITIES=$(jq '.vulnerabilities | length' security_report.json)
    if [ "$VULNERABILITIES" -gt 0 ]; then
        log_warning "$VULNERABILITIES security vulnerabilities found"
        jq '.vulnerabilities' security_report.json
    else
        log_success "No security vulnerabilities detected"
    fi
}

# Execute validation steps
validate_requirements_files
detect_dependency_conflicts
test_version_compatibility
scan_security_vulnerabilities

log_section_complete "Dependency Resolution Testing"
```

### Stage 3: Import Path Validation Script
```bash
#!/bin/bash
# scripts/validate-imports.sh

set -e
source scripts/common-functions.sh

log_section "Import Path Validation"

# Package Import Testing
test_package_imports() {
    log_step "Testing package imports"
    
    # Create clean test environment
    python3 -m venv import_test_venv
    source import_test_venv/bin/activate
    
    # Install CodeRipple package
    pip install -e coderipple/
    
    # Test core imports
    python3 -c "
import sys
print(f'Python path: {sys.path}')

# Test CodeRipple package imports
try:
    from coderipple.tourist_guide_agent import analyze_user_workflow_impact
    from coderipple.building_inspector_agent import analyze_system_changes
    from coderipple.historian_agent import analyze_decision_significance
    from coderipple.orchestrator_agent import process_webhook
    print('✅ All CodeRipple agent imports successful')
except ImportError as e:
    print(f'❌ CodeRipple import error: {e}')
    sys.exit(1)

# Test external dependency imports
try:
    import boto3
    import strands_agents
    import requests
    print('✅ All external dependency imports successful')
except ImportError as e:
    print(f'❌ External dependency import error: {e}')
    sys.exit(1)
"
    
    deactivate
    rm -rf import_test_venv
    
    log_success "Package import testing completed"
}

# Module Resolution Verification
verify_module_resolution() {
    log_step "Verifying module resolution"
    
    # Test module discovery
    python3 -c "
import pkgutil
import coderipple

print('CodeRipple package modules:')
for importer, modname, ispkg in pkgutil.iter_modules(coderipple.__path__, coderipple.__name__ + '.'):
    print(f'  {modname} (package: {ispkg})')
"
    
    log_success "Module resolution verified"
}

# Circular Dependency Detection
detect_circular_dependencies() {
    log_step "Detecting circular dependencies"
    
    # Install dependency analysis tool
    pip install pydeps
    
    # Analyze CodeRipple package for circular dependencies
    pydeps coderipple/src/coderipple --show-deps --max-bacon=2 > dependency_analysis.txt
    
    # Check for circular imports
    if grep -q "circular" dependency_analysis.txt; then
        log_warning "Potential circular dependencies detected"
        cat dependency_analysis.txt
    else
        log_success "No circular dependencies detected"
    fi
}

# CodeRipple Package Structure Validation
validate_package_structure() {
    log_step "Validating CodeRipple package structure"
    
    # Check required files
    REQUIRED_FILES=(
        "coderipple/src/coderipple/__init__.py"
        "coderipple/src/coderipple/tourist_guide_agent.py"
        "coderipple/src/coderipple/building_inspector_agent.py"
        "coderipple/src/coderipple/historian_agent.py"
        "coderipple/src/coderipple/orchestrator_agent.py"
        "coderipple/setup.py"
    )
    
    for file in "${REQUIRED_FILES[@]}"; do
        if [ ! -f "$file" ]; then
            log_error "Required file missing: $file"
            exit 1
        fi
    done
    
    # Validate setup.py
    python3 coderipple/setup.py check
    
    log_success "Package structure validation completed"
}

# Execute validation steps
test_package_imports
verify_module_resolution
detect_circular_dependencies
validate_package_structure

log_section_complete "Import Path Validation"
```

### Common Functions Library
```bash
#!/bin/bash
# scripts/common-functions.sh

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_section() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════════${NC}\n"
}

log_section_complete() {
    echo -e "\n${GREEN}✅ $1 - COMPLETED${NC}\n"
}

log_step() {
    echo -e "${BLUE}🔍 $1...${NC}"
}

log_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

log_error() {
    echo -e "${RED}❌ $1${NC}"
}

log_debug() {
    echo -e "${YELLOW}🐛 DEBUG: $1${NC}"
}

# Environment snapshot function
capture_environment_snapshot() {
    local snapshot_file="environment_snapshot_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "=== Environment Snapshot ==="
        echo "Timestamp: $(date)"
        echo "Python Version: $(python3 --version)"
        echo "Python Executable: $(which python3)"
        echo "Pip Version: $(pip --version)"
        echo "Working Directory: $(pwd)"
        echo "Environment Variables:"
        env | grep -E "(PYTHON|PIP|PATH)" | sort
        echo ""
        echo "=== Installed Packages ==="
        pip list
        echo ""
        echo "=== Directory Structure ==="
        find . -name "*.py" -o -name "requirements.txt" -o -name "setup.py" | head -20
    } > "$snapshot_file"
    
    echo "Environment snapshot saved: $snapshot_file"
}

# Error handler with debugging information
handle_error() {
    local exit_code=$?
    local line_number=$1
    
    log_error "Error occurred on line $line_number (exit code: $exit_code)"
    capture_environment_snapshot
    
    # Additional debugging information
    echo -e "\n${RED}=== DEBUGGING INFORMATION ===${NC}"
    echo "Last command: $BASH_COMMAND"
    echo "Script: $0"
    echo "Line: $line_number"
    
    exit $exit_code
}

# Set error trap
trap 'handle_error $LINENO' ERR
```

## Enhanced Debugging Features

### Detailed Error Reporting
- **Environment snapshots**: Capture system state on failures
- **Dependency trees**: Visual representation of package relationships
- **Import traces**: Detailed import path resolution information
- **Performance metrics**: Timing information for each validation stage

### Debugging Artifacts
- `dependency_tree.txt`: Complete dependency hierarchy
- `security_report.json`: Security vulnerability analysis
- `environment_snapshot_*.txt`: System state at time of error
- `validation_report.html`: Comprehensive validation results

## Integration with Existing CI/CD

### GitHub Actions Integration
```yaml
# Add to existing deploy-infrastructure.yml
- name: Enhanced Pre-Deployment Validation
  run: |
    chmod +x scripts/*.sh
    ./scripts/validate-environment.sh
    ./scripts/validate-dependencies.sh
    ./scripts/validate-imports.sh
  
- name: Upload Validation Artifacts
  if: failure()
  uses: actions/upload-artifact@v3
  with:
    name: validation-artifacts
    path: |
      dependency_tree.txt
      security_report.json
      environment_snapshot_*.txt
```

## Expected Benefits

### Immediate Improvements
- **Early Issue Detection**: Catch problems before deployment
- **Rich Debugging Information**: Detailed error context and system state
- **Automated Quality Gates**: Prevent problematic deployments
- **Comprehensive Validation**: All aspects of package management tested

### Long-term Advantages
- **Reduced Debugging Time**: Clear error information and context
- **Improved Reliability**: Comprehensive pre-deployment validation
- **Better Maintainability**: Automated detection of package issues
- **Enhanced Confidence**: Thorough testing before production deployment

## Implementation Checklist

- [ ] Create validation script directory structure
- [ ] Implement common functions library
- [ ] Create environment validation script
- [ ] Implement dependency resolution testing
- [ ] Create import path validation script
- [ ] Integrate with GitHub Actions workflow
- [ ] Test validation pipeline end-to-end
- [ ] Document debugging procedures

## Next Steps

1. **Implement validation scripts**: Create comprehensive testing framework
2. **Integrate with CI/CD**: Add validation steps to GitHub Actions
3. **Test validation pipeline**: Verify all validation stages work correctly
4. **Proceed to 14.4**: CodeRipple Dependencies Layer implementation

---

**Status**: ✅ **COMPLETE** - Comprehensive CI/CD testing framework designed with detailed debugging capabilities and automated quality gates.
