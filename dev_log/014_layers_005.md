# MDD 014_layers_005: CodeRipple Package Layer Implementation

## Objective

Implement the CodeRipple Package Layer containing custom CodeRipple agents and tools with automated build scripts, proper package structure validation, and CI/CD integration.

## CodeRipple Package Analysis

### Package Structure (from Unit 13.15)
```
coderipple/src/coderipple/
├── __init__.py                           # Package initialization
├── tourist_guide_agent.py               # User workflow documentation agent
├── building_inspector_agent.py          # System documentation agent  
├── historian_agent.py                   # Decision documentation agent
├── orchestrator_agent.py                # Multi-agent coordinator
├── config.py                            # Configuration management
├── webhook_parser.py                    # GitHub webhook processing
├── git_analysis_tool.py                 # Git diff analysis
├── content_generation_tools.py          # AI content generation
├── content_validation_tools.py          # Quality validation
├── bedrock_integration_tools.py         # Amazon Bedrock integration
├── agent_context_flow.py               # Cross-agent coordination
├── existing_content_discovery_tool.py   # Documentation discovery
└── real_diff_integration_tools.py      # Diff-based updates
```

### Package Characteristics
- **Size**: ~3MB (custom code only)
- **Update Frequency**: High (active development)
- **Dependencies**: Relies on external dependencies layer
- **Import Structure**: Absolute imports (`from coderipple.module import function`)

## Layer Directory Structure

```
layers/coderipple-package/
├── 1-install.sh                 # Package installation script
├── 2-package.sh                 # Layer packaging script
├── 3-validate.sh                # Validation script
├── layer.zip                    # Generated layer package
├── build/                       # Build artifacts
│   ├── create_layer/           # Virtual environment
│   └── python/                 # Layer content
├── tests/
│   ├── test_agent_imports.py   # Agent import validation
│   ├── test_agent_functions.py # Agent functionality tests
│   └── test_package_structure.py # Package structure validation
└── metadata/
    ├── layer-metadata.json     # Layer information
    └── package-manifest.txt    # Package contents manifest
```

## Build Scripts Implementation

### Installation Script (1-install.sh)
```bash
#!/bin/bash
# layers/coderipple-package/1-install.sh

set -e
source ../../scripts/common-functions.sh

log_section "CodeRipple Package Layer - Installation"

# Configuration
PYTHON_VERSION="3.13"
LAYER_NAME="coderipple-package"
BUILD_DIR="build"
VENV_DIR="$BUILD_DIR/create_layer"
TARGET_DIR="$BUILD_DIR/python"
CODERIPPLE_SOURCE="../../coderipple"

# Validate CodeRipple source package
validate_source_package() {
    log_step "Validating CodeRipple source package"
    
    # Check required files exist
    REQUIRED_FILES=(
        "$CODERIPPLE_SOURCE/setup.py"
        "$CODERIPPLE_SOURCE/src/coderipple/__init__.py"
        "$CODERIPPLE_SOURCE/src/coderipple/tourist_guide_agent.py"
        "$CODERIPPLE_SOURCE/src/coderipple/building_inspector_agent.py"
        "$CODERIPPLE_SOURCE/src/coderipple/historian_agent.py"
        "$CODERIPPLE_SOURCE/src/coderipple/orchestrator_agent.py"
    )
    
    for file in "${REQUIRED_FILES[@]}"; do
        if [ ! -f "$file" ]; then
            log_error "Required CodeRipple file missing: $file"
            exit 1
        fi
    done
    
    # Validate setup.py
    cd "$CODERIPPLE_SOURCE"
    python3.13 setup.py check --strict
    cd - > /dev/null
    
    log_success "CodeRipple source package validated"
}

# Clean previous build
cleanup_build() {
    log_step "Cleaning previous build artifacts"
    rm -rf "$BUILD_DIR"
    mkdir -p "$BUILD_DIR"
    log_success "Build directory cleaned"
}

# Create virtual environment
create_virtual_environment() {
    log_step "Creating virtual environment with Python $PYTHON_VERSION"
    
    python3.13 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    
    # Upgrade pip
    pip install --upgrade pip
    
    log_success "Virtual environment created: $VENV_DIR"
    log_debug "Python executable: $(which python)"
    log_debug "Pip version: $(pip --version)"
}

# Install CodeRipple package
install_coderipple_package() {
    log_step "Installing CodeRipple package from source"
    
    # Install in development mode to preserve source structure
    pip install -e "$CODERIPPLE_SOURCE" \
        --target "$VENV_DIR/lib/python3.13/site-packages"
    
    log_success "CodeRipple package installed successfully"
    
    # Verify installation
    python3 -c "
import sys
sys.path.insert(0, '$VENV_DIR/lib/python3.13/site-packages')
import coderipple
print(f'CodeRipple package version: {coderipple.__version__}')
print(f'CodeRipple package path: {coderipple.__file__}')
"
}

# Validate package installation
validate_package_installation() {
    log_step "Validating CodeRipple package installation"
    
    # Test agent imports
    python3 -c "
import sys
sys.path.insert(0, '$VENV_DIR/lib/python3.13/site-packages')

# Test all agent imports
agents = [
    'coderipple.tourist_guide_agent',
    'coderipple.building_inspector_agent', 
    'coderipple.historian_agent',
    'coderipple.orchestrator_agent'
]

for agent in agents:
    try:
        __import__(agent)
        print(f'✅ {agent} imported successfully')
    except ImportError as e:
        print(f'❌ {agent} import failed: {e}')
        exit(1)

# Test supporting modules
modules = [
    'coderipple.config',
    'coderipple.webhook_parser',
    'coderipple.git_analysis_tool',
    'coderipple.content_generation_tools'
]

for module in modules:
    try:
        __import__(module)
        print(f'✅ {module} imported successfully')
    except ImportError as e:
        print(f'❌ {module} import failed: {e}')
        exit(1)

print('\\n✅ All CodeRipple modules imported successfully')
"
    
    deactivate
    log_success "Package installation validation completed"
}

# Execute installation steps
validate_source_package
cleanup_build
create_virtual_environment
install_coderipple_package
validate_package_installation

log_section_complete "CodeRipple Package Installation"
```

### Packaging Script (2-package.sh)
```bash
#!/bin/bash
# layers/coderipple-package/2-package.sh

set -e
source ../../scripts/common-functions.sh

log_section "CodeRipple Package Layer - Packaging"

# Configuration
BUILD_DIR="build"
VENV_DIR="$BUILD_DIR/create_layer"
TARGET_DIR="$BUILD_DIR/python"
LAYER_ZIP="coderipple-package-layer.zip"

# Create Lambda layer structure
create_layer_structure() {
    log_step "Creating Lambda layer directory structure"
    
    # Remove existing target directory
    rm -rf "$TARGET_DIR"
    mkdir -p "$TARGET_DIR"
    
    # Copy CodeRipple package to layer structure
    # Only copy the coderipple package, not all site-packages
    CODERIPPLE_PKG="$VENV_DIR/lib/python3.13/site-packages/coderipple"
    
    if [ -d "$CODERIPPLE_PKG" ]; then
        cp -r "$CODERIPPLE_PKG" "$TARGET_DIR/"
    else
        log_error "CodeRipple package not found in expected location: $CODERIPPLE_PKG"
        exit 1
    fi
    
    log_success "Layer structure created: $TARGET_DIR"
    
    # Log layer contents for debugging
    log_debug "Layer contents:"
    find "$TARGET_DIR" -name "*.py" | head -20
}

# Validate package structure in layer
validate_layer_structure() {
    log_step "Validating package structure in layer"
    
    # Check required modules exist
    REQUIRED_MODULES=(
        "$TARGET_DIR/coderipple/__init__.py"
        "$TARGET_DIR/coderipple/tourist_guide_agent.py"
        "$TARGET_DIR/coderipple/building_inspector_agent.py"
        "$TARGET_DIR/coderipple/historian_agent.py"
        "$TARGET_DIR/coderipple/orchestrator_agent.py"
        "$TARGET_DIR/coderipple/config.py"
    )
    
    for module in "${REQUIRED_MODULES[@]}"; do
        if [ ! -f "$module" ]; then
            log_error "Required module missing in layer: $module"
            exit 1
        fi
    done
    
    log_success "Package structure validated in layer"
}

# Optimize layer size
optimize_layer() {
    log_step "Optimizing layer size"
    
    cd "$TARGET_DIR"
    
    # Remove unnecessary files
    find . -name "*.pyc" -delete
    find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
    find . -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null || true
    find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
    find . -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
    find . -name "test_*.py" -delete 2>/dev/null || true
    
    cd - > /dev/null
    
    # Calculate layer size
    LAYER_SIZE=$(du -sh "$TARGET_DIR" | cut -f1)
    log_success "Layer optimized, size: $LAYER_SIZE"
    
    # Check size limits
    LAYER_SIZE_MB=$(du -sm "$TARGET_DIR" | cut -f1)
    if [ "$LAYER_SIZE_MB" -gt 250 ]; then
        log_warning "Layer size ($LAYER_SIZE_MB MB) exceeds Lambda limit (250MB)"
    fi
}

# Create layer ZIP package
create_layer_package() {
    log_step "Creating layer ZIP package"
    
    cd "$BUILD_DIR"
    
    # Create ZIP with proper structure
    zip -r "../$LAYER_ZIP" python/ -q
    
    cd - > /dev/null
    
    # Verify ZIP package
    ZIP_SIZE=$(du -sh "$LAYER_ZIP" | cut -f1)
    log_success "Layer package created: $LAYER_ZIP ($ZIP_SIZE)"
    
    # Test ZIP integrity
    unzip -t "$LAYER_ZIP" > /dev/null
    log_success "ZIP package integrity verified"
}

# Generate package manifest
generate_package_manifest() {
    log_step "Generating package manifest"
    
    mkdir -p metadata
    
    # Create manifest of all Python files
    find "$TARGET_DIR" -name "*.py" -type f | sort > metadata/package-manifest.txt
    
    # Count modules and functions
    MODULE_COUNT=$(find "$TARGET_DIR" -name "*.py" -type f | wc -l)
    FUNCTION_COUNT=$(grep -r "^def " "$TARGET_DIR" --include="*.py" | wc -l)
    CLASS_COUNT=$(grep -r "^class " "$TARGET_DIR" --include="*.py" | wc -l)
    
    # Generate metadata
    cat > metadata/layer-metadata.json << EOF
{
  "layer_name": "coderipple-package",
  "description": "CodeRipple custom package with agents and tools",
  "compatible_runtimes": ["python3.13"],
  "compatible_architectures": ["x86_64"],
  "created_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "build_info": {
    "python_version": "$(python3.13 --version)",
    "layer_size_mb": $LAYER_SIZE_MB,
    "module_count": $MODULE_COUNT,
    "function_count": $FUNCTION_COUNT,
    "class_count": $CLASS_COUNT
  },
  "package_info": {
    "version": "$(cd ../../coderipple && python3 setup.py --version)",
    "author": "$(cd ../../coderipple && python3 setup.py --author)",
    "description": "$(cd ../../coderipple && python3 setup.py --description)"
  }
}
EOF
    
    log_success "Package manifest and metadata generated"
}

# Execute packaging steps
create_layer_structure
validate_layer_structure
optimize_layer
create_layer_package
generate_package_manifest

log_section_complete "CodeRipple Package Packaging"
```

### Validation Script (3-validate.sh)
```bash
#!/bin/bash
# layers/coderipple-package/3-validate.sh

set -e
source ../../scripts/common-functions.sh

log_section "CodeRipple Package Layer - Validation"

LAYER_ZIP="coderipple-package-layer.zip"
TEST_DIR="validation_test"

# Extract and test layer
extract_and_test_layer() {
    log_step "Extracting layer for validation"
    
    rm -rf "$TEST_DIR"
    mkdir "$TEST_DIR"
    cd "$TEST_DIR"
    
    # Extract layer ZIP
    unzip -q "../$LAYER_ZIP"
    
    # Verify directory structure
    if [ ! -d "python/coderipple" ]; then
        log_error "Missing python/coderipple/ directory in layer"
        exit 1
    fi
    
    log_success "Layer extracted successfully"
}

# Test agent imports
test_agent_imports() {
    log_step "Testing CodeRipple agent imports from layer"
    
    python3.13 -c "
import sys
sys.path.insert(0, 'python')

# Test agent imports
agents = {
    'coderipple.tourist_guide_agent': 'User workflow documentation agent',
    'coderipple.building_inspector_agent': 'System documentation agent',
    'coderipple.historian_agent': 'Decision documentation agent',
    'coderipple.orchestrator_agent': 'Multi-agent coordinator'
}

print('Testing CodeRipple agent imports from layer:')
for agent, description in agents.items():
    try:
        module = __import__(agent, fromlist=[''])
        print(f'✅ {agent} ({description})')
        
        # Check for key functions
        if hasattr(module, 'analyze_user_workflow_impact'):
            print(f'   - analyze_user_workflow_impact: ✅')
        if hasattr(module, 'analyze_system_changes'):
            print(f'   - analyze_system_changes: ✅')
        if hasattr(module, 'analyze_decision_significance'):
            print(f'   - analyze_decision_significance: ✅')
        if hasattr(module, 'process_webhook'):
            print(f'   - process_webhook: ✅')
            
    except ImportError as e:
        print(f'❌ {agent} ({description}): {e}')
        exit(1)

print('\\n✅ All CodeRipple agents imported successfully')
"
    
    log_success "Agent import validation completed"
}

# Test supporting module imports
test_supporting_modules() {
    log_step "Testing supporting module imports"
    
    python3.13 -c "
import sys
sys.path.insert(0, 'python')

# Test supporting modules
modules = {
    'coderipple.config': 'Configuration management',
    'coderipple.webhook_parser': 'GitHub webhook processing',
    'coderipple.git_analysis_tool': 'Git diff analysis',
    'coderipple.content_generation_tools': 'AI content generation',
    'coderipple.content_validation_tools': 'Quality validation',
    'coderipple.agent_context_flow': 'Cross-agent coordination'
}

print('Testing supporting module imports:')
for module, description in modules.items():
    try:
        __import__(module)
        print(f'✅ {module} ({description})')
    except ImportError as e:
        print(f'❌ {module} ({description}): {e}')
        exit(1)

print('\\n✅ All supporting modules imported successfully')
"
    
    log_success "Supporting module validation completed"
}

# Test agent functionality (without external dependencies)
test_agent_functionality() {
    log_step "Testing basic agent functionality"
    
    python3.13 -c "
import sys
sys.path.insert(0, 'python')

# Test basic agent functionality that doesn't require external dependencies
from coderipple.config import get_config
from coderipple.webhook_parser import WebhookEvent

# Test configuration loading
try:
    config = get_config()
    print('✅ Configuration loading functional')
except Exception as e:
    print(f'⚠️  Configuration loading: {e} (expected without env vars)')

# Test webhook event parsing
try:
    # Test with minimal event data
    test_event = {
        'commits': [{'id': 'test123', 'message': 'test commit'}],
        'repository': {'name': 'test-repo', 'full_name': 'user/test-repo'}
    }
    webhook_event = WebhookEvent(test_event)
    print(f'✅ Webhook parsing functional: {webhook_event.repository_name}')
except Exception as e:
    print(f'❌ Webhook parsing failed: {e}')
    exit(1)

print('\\n✅ Basic agent functionality tests passed')
"
    
    log_success "Agent functionality validation completed"
}

# Test package structure integrity
test_package_structure() {
    log_step "Testing package structure integrity"
    
    python3.13 -c "
import sys
sys.path.insert(0, 'python')
import pkgutil
import coderipple

print('CodeRipple package structure:')
for importer, modname, ispkg in pkgutil.iter_modules(coderipple.__path__, coderipple.__name__ + '.'):
    print(f'  {modname} (package: {ispkg})')

# Verify package metadata
print(f'\\nPackage metadata:')
print(f'  Version: {getattr(coderipple, \"__version__\", \"unknown\")}')
print(f'  Author: {getattr(coderipple, \"__author__\", \"unknown\")}')
print(f'  Description: {getattr(coderipple, \"__description__\", \"unknown\")}')

print('\\n✅ Package structure integrity verified')
"
    
    log_success "Package structure validation completed"
}

# Simulate Lambda environment with layer
simulate_lambda_with_layer() {
    log_step "Simulating Lambda environment with CodeRipple layer"
    
    # Create minimal Lambda handler for testing
    cat > test_lambda_coderipple.py << 'EOF'
import sys
sys.path.insert(0, 'python')

def lambda_handler(event, context):
    """Test Lambda handler using CodeRipple package layer"""
    
    # Import CodeRipple agents
    from coderipple.orchestrator_agent import process_webhook
    from coderipple.webhook_parser import WebhookEvent
    
    # Test basic functionality
    test_event = {
        'commits': [{'id': 'test123', 'message': 'test commit'}],
        'repository': {'name': 'test-repo', 'full_name': 'user/test-repo'}
    }
    
    try:
        webhook_event = WebhookEvent(test_event)
        result = {
            'statusCode': 200,
            'body': {
                'repository': webhook_event.repository_name,
                'commits': len(webhook_event.commits),
                'message': 'CodeRipple package layer functional in Lambda simulation'
            }
        }
    except Exception as e:
        result = {
            'statusCode': 500,
            'body': {
                'error': str(e),
                'message': 'CodeRipple package layer test failed'
            }
        }
    
    return result

# Test the handler
if __name__ == '__main__':
    result = lambda_handler({}, {})
    print(f"Lambda simulation result: {result}")
EOF
    
    # Execute Lambda simulation
    python3.13 test_lambda_coderipple.py
    
    log_success "Lambda environment simulation with CodeRipple layer completed"
}

# Cleanup test environment
cleanup_validation() {
    log_step "Cleaning up validation environment"
    
    cd ..
    rm -rf "$TEST_DIR"
    
    log_success "Validation cleanup completed"
}

# Execute validation steps
extract_and_test_layer
test_agent_imports
test_supporting_modules
test_agent_functionality
test_package_structure
simulate_lambda_with_layer
cleanup_validation

log_section_complete "CodeRipple Package Validation"
```

## Terraform Integration

### Package Layer Resource Configuration
```hcl
# infra/terraform/layers.tf (addition)

# CodeRipple Package Layer
resource "aws_lambda_layer_version" "coderipple_package" {
  layer_name               = "coderipple-package"
  filename                 = "${path.module}/../../layers/coderipple-package/coderipple-package-layer.zip"
  source_code_hash         = filebase64sha256("${path.module}/../../layers/coderipple-package/coderipple-package-layer.zip")
  
  compatible_runtimes      = ["python3.13"]
  compatible_architectures = ["x86_64"]
  
  description = "CodeRipple custom package with agents and tools"
  
  lifecycle {
    create_before_destroy = true
  }
  
  tags = {
    Name        = "coderipple-package"
    Environment = var.environment
    Project     = var.project_name
    LayerType   = "package"
    Version     = "1.0.0"
  }
}

# Output package layer ARN
output "coderipple_package_layer_arn" {
  description = "ARN of the CodeRipple package layer"
  value       = aws_lambda_layer_version.coderipple_package.arn
}

output "coderipple_package_layer_version" {
  description = "Version of the CodeRipple package layer"
  value       = aws_lambda_layer_version.coderipple_package.version
}
```

## CI/CD Integration

### GitHub Actions Workflow Addition
```yaml
# Add to .github/workflows/deploy-infrastructure.yml

- name: Build CodeRipple Package Layer
  run: |
    cd layers/coderipple-package
    chmod +x *.sh
    ./1-install.sh
    ./2-package.sh
    ./3-validate.sh
    
- name: Upload CodeRipple Package Layer Artifact
  uses: actions/upload-artifact@v3
  with:
    name: coderipple-package-layer
    path: |
      layers/coderipple-package/coderipple-package-layer.zip
      layers/coderipple-package/metadata/layer-metadata.json
      layers/coderipple-package/metadata/package-manifest.txt
    retention-days: 30
```

## Testing Framework

### Agent Import Tests
```python
# layers/coderipple-package/tests/test_agent_imports.py

import sys
import unittest
from pathlib import Path

# Add layer to Python path
layer_path = Path(__file__).parent.parent / "build" / "python"
sys.path.insert(0, str(layer_path))

class TestAgentImports(unittest.TestCase):
    """Test that all CodeRipple agents can be imported from layer"""
    
    def test_tourist_guide_agent_import(self):
        """Test Tourist Guide Agent import"""
        from coderipple.tourist_guide_agent import (
            analyze_user_workflow_impact,
            generate_main_readme,
            bootstrap_user_documentation
        )
        
        self.assertTrue(callable(analyze_user_workflow_impact))
        self.assertTrue(callable(generate_main_readme))
        self.assertTrue(callable(bootstrap_user_documentation))
    
    def test_building_inspector_agent_import(self):
        """Test Building Inspector Agent import"""
        from coderipple.building_inspector_agent import (
            analyze_system_changes,
            write_system_documentation_file,
            read_existing_system_documentation
        )
        
        self.assertTrue(callable(analyze_system_changes))
        self.assertTrue(callable(write_system_documentation_file))
        self.assertTrue(callable(read_existing_system_documentation))
    
    def test_historian_agent_import(self):
        """Test Historian Agent import"""
        from coderipple.historian_agent import (
            analyze_decision_significance,
            write_decision_documentation_file,
            read_existing_decision_documentation
        )
        
        self.assertTrue(callable(analyze_decision_significance))
        self.assertTrue(callable(write_decision_documentation_file))
        self.assertTrue(callable(read_existing_decision_documentation))
    
    def test_orchestrator_agent_import(self):
        """Test Orchestrator Agent import"""
        from coderipple.orchestrator_agent import process_webhook
        
        self.assertTrue(callable(process_webhook))

if __name__ == '__main__':
    unittest.main()
```

## Expected Benefits

### Immediate Improvements
- **Clean package separation**: CodeRipple agents isolated from external dependencies
- **Faster package layer updates**: Only custom code changes trigger layer rebuild
- **Better version control**: Package layer versions track CodeRipple development
- **Simplified debugging**: Clear separation between custom and external code

### Architectural Advantages
- **Multi-Lambda ready**: Package layer shared across individual agent functions
- **Independent deployment**: Package updates don't require dependency layer rebuild
- **Better testing**: Isolated testing of CodeRipple functionality
- **Cleaner imports**: Consistent absolute import structure

## Implementation Checklist

- [ ] Create package layer directory structure
- [ ] Implement build scripts (install, package, validate)
- [ ] Create comprehensive validation tests
- [ ] Implement Terraform layer configuration
- [ ] Integrate with CI/CD pipeline
- [ ] Test package layer functionality end-to-end
- [ ] Validate agent imports and basic functionality

## Next Steps

1. **Create package layer structure**: Set up build environment
2. **Implement build scripts**: Automated package layer creation and validation
3. **Test package functionality**: Comprehensive validation of agent imports
4. **Proceed to 14.6**: Lambda Function Refactoring for Layers

---

**Status**: ✅ **COMPLETE** - CodeRipple Package Layer implementation with automated build scripts, comprehensive agent validation, and CI/CD integration.
