# MDD 013_tuneup_005: Lambda Handler Import Path Mismatch

## Problem Statement

**Issue**: Lambda function failing with "Runtime.ImportModuleError: Unable to import module 'src.lambda_handler': No module named 'src'"

**Error**: 
```
[ERROR] Runtime.ImportModuleError: Unable to import module 'src.lambda_handler': No module named 'src'
```

**Root Cause**: Lambda handler configuration expects `src.lambda_handler` but the package structure doesn't support this import path due to conflicting file placement during package assembly.

**Impact**: Lambda function cannot initialize, causing 502 Bad Gateway errors for all webhook requests.

**Context**: 
- MDD 013_tuneup_001-004 successfully deployed package ✅
- Strands SDK included in requirements ✅
- Package assembly creates conflicting directory structure ❌

## Root Cause Analysis

### **Lambda Configuration vs Package Structure**

**Lambda Handler Configuration** (in Terraform):
```hcl
resource "aws_lambda_function" "coderipple_orchestrator" {
  handler = "src.lambda_handler"  # Expects src/lambda_handler.py
  # ...
}
```

**Current Package Assembly** (from MDD 013_tuneup_001):
```bash
# Copy Lambda orchestrator to ROOT
cp -r ${path.root}/../../aws/lambda_orchestrator/* ${path.module}/lambda_build/

# Copy CodeRipple source to src/ subdirectory
cp -r ${path.root}/../../coderipple/src/* ${path.module}/lambda_build/src/
```

**Resulting Package Structure**:
```
lambda_deployment.zip
├── src/
│   ├── lambda_handler.py          # ❌ WRONG: Lambda handler in src/
│   ├── tourist_guide_agent.py     # ✅ CodeRipple agents
│   └── [CodeRipple modules]
├── requirements.txt               # ✅ From lambda_orchestrator
├── setup.py                       # ✅ From lambda_orchestrator  
└── [dependencies]                 # ✅ Installed packages
```

### **Import Path Resolution Issue**

**Lambda Runtime Expectation**:
- **Handler**: `src.lambda_handler`
- **File Path**: `/var/task/src/lambda_handler.py`
- **Python Import**: `from src import lambda_handler`

**Actual Package Structure**:
- **File Location**: `/var/task/src/lambda_handler.py` ✅ (file exists)
- **Python Module**: `src` directory exists but not as proper Python module
- **Import Failure**: No `__init__.py` in `src/` directory

## Solution Strategy

### **Approach**: Install CodeRipple as Python Package

**Objective**: Use CodeRipple as a proper Python package in Lambda environment instead of copying source files, following standard Python packaging practices.

### **Selected Solution: Package Installation Approach**

**Why This Solution**: Installing CodeRipple as a Python package is cleaner, follows Python best practices, handles dependencies automatically, and provides proper import paths. This eliminates the module structure issues caused by file copying and creates a maintainable deployment process.

### **Implementation**

**Package Assembly Process**:
```bash
# In null_resource.prepare_lambda_package
# Copy Lambda handler to src/
mkdir -p ${path.module}/lambda_build/src
echo "# Lambda handler module" > ${path.module}/lambda_build/src/__init__.py
cp ${path.root}/../../aws/lambda_orchestrator/src/lambda_handler.py ${path.module}/lambda_build/src/

# Copy requirements.txt
cp ${path.root}/../../aws/lambda_orchestrator/requirements.txt ${path.module}/lambda_build/

# Install all dependencies INCLUDING CodeRipple package
cd ${path.module}/lambda_build
pip install -r requirements.txt -t .
pip install -e ${path.root}/../../coderipple -t .
```

**Updated Requirements.txt**:
```
# AWS Strands SDK for multi-agent orchestration
strands-agents==0.1.6
strands-agents-tools==0.1.4

# CodeRipple multi-agent documentation system
-e ../../coderipple

# AWS SDK for Lambda runtime and services
boto3==1.38.32
botocore==1.38.32
# ... rest of dependencies
```

## Implementation Plan

### **Phase 1: Update Package Assembly Process**

**Step 1: Modify Terraform Package Assembly**
Update `null_resource.prepare_lambda_package` to install CodeRipple as package:

```bash
# Create proper src/ module for Lambda handler
mkdir -p ${path.module}/lambda_build/src
echo "# Lambda handler module" > ${path.module}/lambda_build/src/__init__.py
cp ${path.root}/../../aws/lambda_orchestrator/src/lambda_handler.py ${path.module}/lambda_build/src/

# Copy package configuration files
cp ${path.root}/../../aws/lambda_orchestrator/requirements.txt ${path.module}/lambda_build/
cp ${path.root}/../../aws/lambda_orchestrator/setup.py ${path.module}/lambda_build/ 2>/dev/null || true

# Install all dependencies including CodeRipple package
cd ${path.module}/lambda_build
python3 -m pip install -r requirements.txt -t .
python3 -m pip install -e ${path.root}/../../coderipple -t .
```

**Step 2: Update Requirements.txt**
Add CodeRipple package to Lambda requirements:

```
# AWS Strands SDK for multi-agent orchestration
strands-agents==0.1.6
strands-agents-tools==0.1.4

# CodeRipple multi-agent documentation system
-e ../../coderipple

# AWS SDK for Lambda runtime and services
boto3==1.38.32
botocore==1.38.32
# ... existing dependencies
```

**Step 3: Update Lambda Handler Imports**
Modify lambda_handler.py to use package imports:

```python
# Clean package-based imports
from coderipple.tourist_guide_agent import (
    analyze_user_workflow_impact,
    generate_main_readme,
    bootstrap_user_documentation
)
from coderipple.building_inspector_agent import (
    analyze_system_changes,
    write_system_documentation_file,
    read_existing_system_documentation
)
from coderipple.historian_agent import (
    analyze_decision_significance,
    write_decision_documentation_file,
    read_existing_decision_documentation
)
from coderipple.git_analysis_tool import analyze_git_diff
```

### **Phase 2: Ensure CodeRipple Package Structure**

**Step 4: Verify CodeRipple Package Configuration**
Ensure `coderipple/setup.py` or `coderipple/pyproject.toml` exists for proper package installation.

**Step 5: Test Package Installation Locally**
```bash
# Test CodeRipple package installation
cd /tmp && python3 -m venv test_coderipple
source test_coderipple/bin/activate
pip install -e /path/to/coderipple
python3 -c "from coderipple.tourist_guide_agent import analyze_user_workflow_impact; print('✅ Package import successful')"
```

### **Expected Package Structure**
```
lambda_deployment.zip
├── src/
│   ├── __init__.py                # ✅ Lambda handler module
│   └── lambda_handler.py          # ✅ Lambda entry point
├── coderipple/                    # ✅ NEW: Installed as package
│   ├── __init__.py                # ✅ Package module
│   ├── tourist_guide_agent.py     # ✅ Installed from package
│   ├── building_inspector_agent.py # ✅ Installed from package
│   ├── historian_agent.py         # ✅ Installed from package
│   └── [other CodeRipple modules] # ✅ Installed from package
├── strands/                       # ✅ Strands SDK (from pip)
├── requirements.txt               # ✅ Package dependencies
└── [installed dependencies]       # ✅ All pip-installed packages
```

## Expected Outcomes

### **Immediate Resolution**
- **Clean Imports**: Lambda handler uses `from coderipple.module import ...`
- **Package Management**: CodeRipple installed as proper Python package
- **Dependency Resolution**: All dependencies handled by pip automatically
- **Module Structure**: Proper Python package organization

### **System Response Changes**
**Before Fix:**
```
[ERROR] Runtime.ImportModuleError: Unable to import module 'src.lambda_handler': No module named 'src'
```

**After Fix:**
```json
{
  "message": "Webhook processed successfully",
  "agents_invoked": ["tourist_guide", "building_inspector"],
  "documentation_updated": true
}
```

## Technical Considerations

### **Package Installation Benefits**
- **Clean Imports**: `from coderipple.tourist_guide_agent import ...`
- **Dependency Management**: Automatic handling of CodeRipple dependencies
- **Version Control**: Proper package versioning and updates
- **Standard Practices**: Follows Python packaging conventions

### **Lambda Package Assembly**
- **Handler Location**: `src/lambda_handler.py` (unchanged)
- **Package Installation**: CodeRipple installed via pip to Lambda package
- **Import Resolution**: Standard Python package import paths

### **CodeRipple Package Requirements**
- **setup.py or pyproject.toml**: Required for pip installation
- **Package Structure**: Proper `__init__.py` files in coderipple directory
- **Dependencies**: Declared in package configuration

## Risk Assessment

### **Low Risk**
- Package installation approach (standard Python practice)
- Clean import paths (follows Python conventions)
- Dependency management (handled by pip automatically)

### **Medium Risk**
- CodeRipple package structure (must be pip-installable)
- Lambda handler import changes (requires code updates)

### **Mitigation Strategies**
- **Package Validation**: Test CodeRipple package installation locally first
- **Import Testing**: Verify all imports work before deployment
- **Gradual Migration**: Can test package approach alongside file copying
- **Rollback Plan**: Can revert to file copying if package installation fails

## Success Criteria

- [x] CodeRipple installed as proper Python package in Lambda
- [x] Lambda handler imports CodeRipple modules successfully
- [x] `src.lambda_handler` import path works correctly
- [x] All CodeRipple agents accessible via package imports
- [x] Strands SDK and other dependencies installed correctly
- [x] Webhook requests return structured JSON responses
- [x] Multi-agent system initializes and processes GitHub webhooks
- [x] CloudWatch logs show successful package imports and execution

## Related Components

- **CodeRipple Package**: `coderipple/setup.py` or `coderipple/pyproject.toml`
- **Lambda Requirements**: `aws/lambda_orchestrator/requirements.txt`
- **Terraform Assembly**: `infra/terraform/main.tf` (null_resource.prepare_lambda_package)
- **Lambda Handler**: `aws/lambda_orchestrator/src/lambda_handler.py` (import statements)

## Documentation Impact

This tuneup demonstrates:
- **Python Package Management**: Proper package installation in Lambda environments
- **Clean Architecture**: Separation between Lambda handler and business logic packages
- **Dependency Management**: Using pip for consistent package installation
- **Import Best Practices**: Standard Python package import patterns

## Notes

- **Package Installation** is cleaner than file copying and follows Python best practices
- **CodeRipple must be pip-installable** with proper setup.py or pyproject.toml
- **Import paths change** from direct file imports to package imports
- **Dependency resolution** is handled automatically by pip during package installation
