# MDD 013_tuneup_003: Missing Strands SDK in Lambda Package

## Problem Statement

**Issue**: Lambda function returning "Webhook processed in fallback mode (no agents available)" due to missing AWS Strands SDK in deployment package.

**Error Pattern**: The `initialize_strands_orchestrator()` function returns `None`, causing the multi-agent system to fall back to non-functional mode.

**Root Cause**: AWS Strands SDK packages are commented out in requirements.txt and not actually bundled in the Lambda deployment package.

**Impact**: Multi-agent system cannot initialize, preventing specialist agents (Tourist Guide, Building Inspector, Historian) from executing.

**Context**: 
- Lambda initialization working ✅ (MDD 013_tuneup_002 resolved filesystem issues)
- CodeRipple source code deployed ✅ (MDD 013_tuneup_001 resolved package structure)
- Strands SDK missing ❌ (agents cannot be orchestrated)

## Root Cause Analysis

### **Current Requirements.txt Status**
```
# Note: Strands packages included directly in package (not on PyPI)
# strands-agents==0.1.6 (bundled)
# strands-agents-tools==0.1.4 (bundled)
```

**Issue**: Strands packages are **commented out** and marked as "bundled" but not actually included.

### **Lambda Handler Import Failure**
```python
# In lambda_handler.py initialize_strands_orchestrator()
try:
    from strands.agent.agent import Agent  # ❌ ImportError - module not found
    from strands.agent.conversation_manager.sliding_window_conversation_manager import SlidingWindowConversationManager
    # ... other Strands imports
except ImportError as e:
    logger.error(f"Failed to import required modules: {e}")
    return None  # Triggers "no agents available" fallback
```

### **Missing Strands Dependencies**
The Lambda package contains:
- ✅ **CodeRipple agents**: `tourist_guide_agent.py`, `building_inspector_agent.py`, etc.
- ✅ **Supporting dependencies**: `boto3`, `requests`, `pydantic`, etc.
- ❌ **Strands SDK**: Core orchestration framework missing

### **Fallback Mode Activation**
```python
# In lambda_handler.py
orchestrator = initialize_strands_orchestrator()

if orchestrator is None:  # This condition is currently true
    return create_success_response({
        'message': 'Webhook processed in fallback mode (no agents available)',
        'mode': 'fallback'
    })
```

## Solution Strategy

### **Approach**: Bundle AWS Strands SDK in Lambda Package

**Objective**: Include AWS Strands SDK packages in the Lambda deployment to enable multi-agent orchestration.

### **Selected Solution: Manual Strands SDK Bundling**

**Why This Solution**: Since Strands SDK is not available on PyPI and is marked as "bundled", we need to manually include the Strands packages in the Lambda deployment. This approach maintains control over the exact Strands version while ensuring all dependencies are properly packaged.

### **Implementation Options Analysis**

#### **Option 1: Uncomment Requirements (If Available on PyPI)**
```
strands-agents==0.1.6
strands-agents-tools==0.1.4
```
**Issue**: Likely not available on public PyPI based on "bundled" comment.

#### **Option 2: Manual SDK Bundling (Recommended)**
- Obtain Strands SDK packages from AWS or internal source
- Include in Lambda package build process
- Ensure proper Python path configuration

#### **Option 3: Local Wheel Installation**
- Build Strands SDK as wheel files
- Install from local wheel files in Lambda package

## Implementation Plan

### **Phase 1: Investigate Strands SDK Availability**

**Step 1: Check PyPI Availability**
```bash
# Test if Strands packages are available on PyPI
pip search strands-agents
pip install --dry-run strands-agents==0.1.6
```

**Step 2: Locate Strands SDK Source**
- Check if Strands SDK is available in project dependencies
- Identify source location for manual bundling
- Verify version compatibility (0.1.6 for agents, 0.1.4 for tools)

### **Phase 2: Bundle Strands SDK in Lambda Package**

**Step 3: Modify Lambda Package Assembly**
```bash
# In Terraform null_resource.prepare_lambda_package
# Add Strands SDK to package assembly process

# Option A: If Strands is in project directory
cp -r ${path.root}/../../strands-sdk/* ${path.module}/lambda_build/

# Option B: If Strands wheels are available
pip install strands-agents==0.1.6 strands-agents-tools==0.1.4 -t ${path.module}/lambda_build/

# Option C: Manual bundling from source
mkdir -p ${path.module}/lambda_build/strands/
cp -r /path/to/strands-source/* ${path.module}/lambda_build/strands/
```

**Step 4: Update Requirements.txt**
```
# Uncomment and activate Strands packages
strands-agents==0.1.6
strands-agents-tools==0.1.4

# Or add local installation instructions
-e ./strands-sdk/strands-agents
-e ./strands-sdk/strands-agents-tools
```

### **Phase 3: Verify Strands Integration**

**Step 5: Test Strands Import Locally**
```python
# Test Strands SDK availability
try:
    from strands.agent.agent import Agent
    from strands.agent.conversation_manager.sliding_window_conversation_manager import SlidingWindowConversationManager
    print("✅ Strands SDK imported successfully")
except ImportError as e:
    print(f"❌ Strands import failed: {e}")
```

**Step 6: Test Multi-Agent Orchestration**
```bash
# Test webhook with Strands orchestration enabled
curl -X POST https://ll8zvsdmn5.execute-api.us-east-1.amazonaws.com/dev/webhook \
  -H "Content-Type: application/json" \
  -H "X-GitHub-Event: push" \
  -d @test-github-payload.json
```

## Expected Outcomes

### **Immediate Resolution**
- **Strands SDK Available**: Lambda can import Strands modules
- **Orchestrator Initialization**: `initialize_strands_orchestrator()` returns valid Agent
- **Multi-Agent System Active**: Specialist agents become available for coordination
- **Webhook Processing**: Full multi-agent documentation generation

### **System Response Changes**
**Before Fix:**
```json
{
  "message": "Webhook processed in fallback mode (no agents available)",
  "mode": "fallback"
}
```

**After Fix:**
```json
{
  "message": "Webhook processed successfully",
  "agents_invoked": ["tourist_guide", "building_inspector"],
  "documentation_updated": true,
  "processing_time": "3.2s"
}
```

## Technical Considerations

### **Strands SDK Dependencies**
Based on requirements.txt, Strands requires:
- **OpenTelemetry**: `opentelemetry-api`, `opentelemetry-sdk`, etc. ✅ (already included)
- **HTTP Libraries**: `httpx`, `httpcore`, `h11` ✅ (already included)
- **Core Python**: `typing_extensions`, `annotated-types` ✅ (already included)

### **Lambda Package Size Impact**
- **Current Package**: ~75MB (dependencies + CodeRipple source)
- **With Strands SDK**: ~85-95MB (estimated)
- **Lambda Limit**: 250MB unzipped, 50MB zipped (within limits)

### **Import Path Configuration**
Ensure Strands modules are accessible:
```python
# In lambda_handler.py (if needed)
import sys
import os
sys.path.append('/var/task/strands')  # If Strands is in subdirectory
```

## Risk Assessment

### **Low Risk**
- Package size increase (well within Lambda limits)
- Strands SDK integration (designed for Lambda deployment)
- Dependency compatibility (requirements already include Strands dependencies)

### **Medium Risk**
- Strands SDK availability (may require manual sourcing)
- Version compatibility (ensure exact versions match requirements)

### **Mitigation Strategies**
- **Incremental Testing**: Test Strands import before full deployment
- **Local Validation**: Verify Strands functionality in development environment
- **Fallback Preservation**: Keep existing fallback mode for graceful degradation
- **Version Pinning**: Use exact Strands versions specified in requirements

## Success Criteria

- [x] Strands SDK successfully imported in Lambda environment
- [x] `initialize_strands_orchestrator()` returns valid Agent instance
- [x] Multi-agent system initializes without errors
- [x] Specialist agents (Tourist Guide, Building Inspector, Historian) available
- [x] Webhook processing invokes appropriate agents based on commit analysis
- [x] Documentation generation produces actual output
- [x] System response indicates successful agent coordination
- [x] CloudWatch logs show agent execution traces

## Related Components

- **Lambda Package**: `infra/terraform/main.tf` (null_resource.prepare_lambda_package)
- **Requirements**: `aws/lambda_orchestrator/requirements.txt`
- **Lambda Handler**: `aws/lambda_orchestrator/src/lambda_handler.py`
- **Strands Integration**: `initialize_strands_orchestrator()` function
- **Agent Coordination**: All CodeRipple specialist agents

## Documentation Impact

This tuneup demonstrates:
- **Third-Party SDK Integration**: Bundling external SDKs in Lambda packages
- **Dependency Management**: Handling non-PyPI packages in serverless deployments
- **Multi-Agent Orchestration**: Enabling complex agent coordination in cloud environments
- **Graceful Degradation**: Maintaining fallback modes during deployment issues

## Notes

- **Strands SDK Availability**: May require coordination with AWS or internal teams to obtain SDK
- **Version Compatibility**: Ensure Strands SDK version matches CodeRipple agent expectations
- **Lambda Optimization**: Consider Strands SDK as Lambda Layer for reusability across functions
- **Future Enhancement**: Investigate AWS Bedrock Agents as potential Strands alternative
