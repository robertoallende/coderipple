# MDD 014_layers_004: Layer Architecture Design and Planning

## Objective

Design comprehensive Lambda Layers architecture for CodeRipple multi-agent system, establishing foundation for dependency separation, deployment simplification, and multi-Lambda scalability.

## Current State Analysis

### CodeRipple Dependencies Profile
```
# External Dependencies (50+ packages)
boto3==1.38.32
botocore==1.38.32
strands-agents==0.1.6
strands-agents-tools==0.1.4
requests==2.32.3
# ... additional packages

# Custom CodeRipple Package
coderipple/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ tourist_guide_agent.py
‚îú‚îÄ‚îÄ building_inspector_agent.py
‚îú‚îÄ‚îÄ historian_agent.py
‚îú‚îÄ‚îÄ orchestrator_agent.py
‚îî‚îÄ‚îÄ ... (supporting modules)
```

### Current Deployment Issues
- **Package Path Resolution**: Complex `../../../coderipple/setup.py` paths in Terraform
- **Bundle Size**: 28MB+ deployment package with all dependencies
- **Deployment Time**: Slow deployments due to dependency repackaging
- **Scalability Limits**: Single Lambda constrains multi-agent architecture

## Layer Architecture Design

### Layer 1: CodeRipple External Dependencies
**Purpose**: Stable external packages that change infrequently
**Contents**:
- boto3, botocore (AWS SDK)
- strands-agents, strands-agents-tools (Multi-agent framework)
- requests, urllib3 (HTTP libraries)
- All other external dependencies from requirements.txt

**Characteristics**:
- **Update Frequency**: Low (security patches, major version updates)
- **Size**: ~25MB (majority of current package size)
- **Stability**: High (pinned versions)
- **Sharing**: Shared across all CodeRipple Lambda functions

### Layer 2: CodeRipple Package
**Purpose**: Custom CodeRipple agents and tools
**Contents**:
- All modules from `coderipple/src/coderipple/` package
- Agent implementations (tourist_guide, building_inspector, historian, orchestrator)
- Supporting tools and utilities

**Characteristics**:
- **Update Frequency**: High (active development)
- **Size**: ~3MB (custom code only)
- **Stability**: Medium (evolving codebase)
- **Sharing**: Shared across agent-specific Lambda functions

## Directory Structure Design

Based on AWS Lambda best practices:

```
coderipple/
‚îú‚îÄ‚îÄ layers/
‚îÇ   ‚îú‚îÄ‚îÄ dependencies/                    # Layer 1: External Dependencies
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt            # External package specifications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 1-install.sh               # Dependency installation script
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2-package.sh               # Layer packaging script
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layer.zip                  # Generated layer package
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ coderipple-package/            # Layer 2: CodeRipple Package
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 1-install.sh               # Package installation script
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2-package.sh               # Layer packaging script
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layer.zip                  # Generated layer package
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ shared/                        # Shared build utilities
‚îÇ       ‚îú‚îÄ‚îÄ build-common.sh            # Common build functions
‚îÇ       ‚îî‚îÄ‚îÄ validate-layer.sh          # Layer validation script
‚îÇ
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator/                  # Orchestrator Lambda function
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lambda_function.py         # Function code only
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ tourist-guide/                 # Future: Individual agent functions
‚îÇ   ‚îú‚îÄ‚îÄ building-inspector/
‚îÇ   ‚îî‚îÄ‚îÄ historian/
‚îÇ
‚îî‚îÄ‚îÄ infra/terraform/
    ‚îú‚îÄ‚îÄ layers.tf                      # Layer resource definitions
    ‚îî‚îÄ‚îÄ functions.tf                   # Function configurations with layers
```

## Build Script Architecture

### Dependencies Layer Build (1-install.sh)
```bash
#!/bin/bash
set -e

echo "üîß Building CodeRipple Dependencies Layer..."

# Create clean virtual environment
python3.13 -m venv create_layer
source create_layer/bin/activate

# Install dependencies with platform targeting
pip install -r requirements.txt \
    --platform=manylinux2014_x86_64 \
    --only-binary=:all: \
    --target ./create_layer/lib/python3.13/site-packages

echo "‚úÖ Dependencies installed successfully"
```

### Dependencies Layer Package (2-package.sh)
```bash
#!/bin/bash
set -e

echo "üì¶ Packaging CodeRipple Dependencies Layer..."

# Create proper Lambda layer structure
mkdir -p python
cp -r create_layer/lib/python3.13/site-packages/* python/

# Create layer ZIP
zip -r coderipple-dependencies-layer.zip python/

echo "‚úÖ Layer packaged: coderipple-dependencies-layer.zip"
```

### CodeRipple Package Layer Build (1-install.sh)
```bash
#!/bin/bash
set -e

echo "üîß Building CodeRipple Package Layer..."

# Create clean virtual environment
python3.13 -m venv create_layer
source create_layer/bin/activate

# Install CodeRipple package from source
pip install ../../../coderipple -t ./create_layer/lib/python3.13/site-packages

echo "‚úÖ CodeRipple package installed successfully"
```

## Terraform Layer Configuration

### Layer Resource Definitions
```hcl
# CodeRipple Dependencies Layer
resource "aws_lambda_layer_version" "coderipple_dependencies" {
  layer_name          = "coderipple-dependencies"
  filename            = "${path.module}/../../layers/dependencies/coderipple-dependencies-layer.zip"
  source_code_hash    = filebase64sha256("${path.module}/../../layers/dependencies/coderipple-dependencies-layer.zip")
  
  compatible_runtimes = ["python3.13"]
  compatible_architectures = ["x86_64"]
  
  description = "CodeRipple external dependencies (boto3, strands-agents, etc.)"
  
  lifecycle {
    create_before_destroy = true
  }
}

# CodeRipple Package Layer
resource "aws_lambda_layer_version" "coderipple_package" {
  layer_name          = "coderipple-package"
  filename            = "${path.module}/../../layers/coderipple-package/coderipple-package-layer.zip"
  source_code_hash    = filebase64sha256("${path.module}/../../layers/coderipple-package/coderipple-package-layer.zip")
  
  compatible_runtimes = ["python3.13"]
  compatible_architectures = ["x86_64"]
  
  description = "CodeRipple custom package with agents and tools"
  
  lifecycle {
    create_before_destroy = true
  }
}
```

### Function Configuration with Layers
```hcl
resource "aws_lambda_function" "orchestrator" {
  function_name = "coderipple-orchestrator"
  filename      = "${path.module}/../../functions/orchestrator/function.zip"
  
  # Layers attached in dependency order
  layers = [
    aws_lambda_layer_version.coderipple_dependencies.arn,
    aws_lambda_layer_version.coderipple_package.arn
  ]
  
  handler = "lambda_function.lambda_handler"
  runtime = "python3.13"
  
  # Reduced memory since dependencies are in layers
  memory_size = 1024
  timeout     = 900
}
```

## Version Management Strategy

### Semantic Versioning for Layers
- **Dependencies Layer**: `v1.0.0` ‚Üí `v1.0.1` (patch updates), `v1.1.0` (minor updates)
- **Package Layer**: `v1.0.0` ‚Üí `v1.1.0` (frequent updates during development)

### Automated Version Management
```bash
# Layer version tagging
DEPENDENCIES_VERSION=$(git describe --tags --match "deps-*" --abbrev=0 2>/dev/null || echo "deps-v1.0.0")
PACKAGE_VERSION=$(git describe --tags --match "pkg-*" --abbrev=0 2>/dev/null || echo "pkg-v1.0.0")

# Layer ARN with version
DEPENDENCIES_ARN="arn:aws:lambda:${AWS_REGION}:${AWS_ACCOUNT}:layer:coderipple-dependencies:${DEPENDENCIES_VERSION}"
```

## Multi-Lambda Preparation

### Shared Layer Strategy
All CodeRipple Lambda functions will use:
1. **Common Dependencies Layer**: Shared across all functions
2. **CodeRipple Package Layer**: Shared agent implementations
3. **Function-specific code**: Minimal, agent-specific logic

### Individual Agent Functions
```
functions/
‚îú‚îÄ‚îÄ orchestrator/           # Webhook entry point
‚îú‚îÄ‚îÄ tourist-guide/         # User workflow documentation
‚îú‚îÄ‚îÄ building-inspector/    # System documentation
‚îî‚îÄ‚îÄ historian/            # Decision documentation
```

Each function:
- Uses both shared layers
- Contains minimal function-specific code
- Optimized memory/timeout per agent type
- Independent scaling and deployment

## Validation and Testing Strategy

### Layer Validation Script
```bash
#!/bin/bash
# validate-layer.sh

echo "üîç Validating layer structure..."

# Check required directory structure
if [ ! -d "python" ]; then
    echo "‚ùå Missing python/ directory"
    exit 1
fi

# Check package imports
python3.13 -c "
import sys
sys.path.insert(0, 'python')
try:
    import boto3
    import strands_agents
    print('‚úÖ Core dependencies importable')
except ImportError as e:
    print(f'‚ùå Import error: {e}')
    exit(1)
"

echo "‚úÖ Layer validation successful"
```

### Integration Testing
- **Layer functionality**: Import and execution validation
- **Lambda environment**: Runtime compatibility testing
- **Multi-layer interaction**: Layer loading order and conflicts
- **Performance impact**: Cold start and execution metrics

## Expected Benefits

### Immediate Improvements
- **Eliminates path resolution issues**: No more `../../../coderipple/setup.py`
- **Faster deployments**: Function code only (~100KB vs 28MB+)
- **Simplified Terraform**: Clean layer resource management
- **Better caching**: Dependencies cached in layers

### Architectural Advantages
- **Multi-Lambda ready**: Foundation for agent separation
- **Resource optimization**: Per-function memory tuning
- **Independent scaling**: Agent-specific scaling policies
- **Better isolation**: Agent failures don't affect others

## Implementation Checklist

- [ ] Create layer directory structure
- [ ] Write build scripts for both layers
- [ ] Create Terraform layer configurations
- [ ] Implement version management strategy
- [ ] Create validation and testing scripts
- [ ] Design multi-Lambda function structure
- [ ] Plan migration from current architecture

## Next Steps

1. **Implement 14.3**: CodeRipple Dependencies Layer creation
2. **Implement 14.4**: CodeRipple Package Layer creation
3. **Validate layer functionality**: Import and execution testing
4. **Integrate with CI/CD**: Automated layer building and deployment

---

**Status**: ‚úÖ **COMPLETE** - Comprehensive layer architecture designed with build scripts, Terraform configuration, and multi-Lambda preparation strategy.
